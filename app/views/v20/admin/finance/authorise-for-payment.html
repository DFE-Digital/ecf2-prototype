{% extends "layouts/print.html" %}
{% set activeNav = 'finance' %}

{# Macro to format currency to 2 decimal places #}
{% macro currency(amount) -%}
{% set rounded = amount|round(2) %}
{% set str = rounded|string %}
{% if '.' in str %}
  {% set parts = str.split('.') %}
  {% set integerPart = parts[0] %}
  {% set decimalPart = parts[1] %}
  {% if decimalPart|length == 1 %}{% set decimalPart = decimalPart + '0' %}{% endif %}
{% else %}
  {% set integerPart = str %}
  {% set decimalPart = '00' %}
{% endif %}
{{ integerPart }}.{{ decimalPart }}
{%- endmacro %}

{% block beforeContent %}
    {{ govukBackLink({
        href: 'javascript:history.back()',
        text: 'Back'
    }) }}
{% endblock %}

{% block content %}
{% if errors and errors.assuranceChecks %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{{ govukErrorSummary({
  titleText: "There is a problem",
  errorList: [
    {
      text: errors.assuranceChecks,
      href: "#assurance-checks"
    }
  ]
}) }}
{% endif %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-l">Check and authorise statement for payment</h1>

        <span class="govuk-caption-l">{{ query.provider }}</span>
        <h2 class="govuk-heading-m">{{ query.statement }}</h2>        
    </div>
</div>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <div class="finance-panel govuk-!-padding-bottom-0">
             <div class="finance-panel__dates">
                <div>
                    <div>
                        <strong class="govuk-body-s govuk-!-margin-bottom-0">Milestone cut off date</strong>
                    </div>
                    <div class="govuk-heading-m govuk-!-padding-top-0">
                        {% set statement_parts = query.statement.split(' ') %}
                        {% set statement_month = statement_parts[0] %}
                        {% set statement_year = statement_parts[1] %}
                        
                        {% set previous_month_map = {
                            "January": ["December", statement_year|int - 1],
                            "February": ["January", statement_year],
                            "March": ["February", statement_year],
                            "April": ["March", statement_year],
                            "May": ["April", statement_year],
                            "June": ["May", statement_year],
                            "July": ["June", statement_year],
                            "August": ["July", statement_year],
                            "September": ["August", statement_year],
                            "October": ["September", statement_year],
                            "November": ["October", statement_year],
                            "December": ["November", statement_year]
                        } %}
                        
                        {% set prev_month = previous_month_map[statement_month][0] %}
                        {% set prev_year = previous_month_map[statement_month][1] %}
                        
                        {% set last_day_map = {
                            "January": "31",
                            "February": "28",
                            "March": "31",
                            "April": "30",
                            "May": "31",
                            "June": "30",
                            "July": "31",
                            "August": "31",
                            "September": "30",
                            "October": "31",
                            "November": "30",
                            "December": "31"
                        } %}
                        
                        {% set prev_month_last_day = last_day_map[prev_month] %}
                        
                        {{ prev_month_last_day }} {{ prev_month }} {{ prev_year }}
                    </div>
                </div>

                <div>
                    <div>
                        <strong class="govuk-body-s govuk-!-margin-bottom-0">Payment date</strong>
                    </div>
                    <div class="govuk-heading-m govuk-!-padding-top-0">
                        {% set statement_last_day = last_day_map[statement_month] %}
                        {{ statement_last_day }} {{ statement_month }} {{ statement_year }}
                    </div>
                </div>
            </div>

            {# Find current statement and generate financial data #}
            {% set currentStatement = null %}
            {% for statement in data.financeData %}
                {% if statement.provider == query.provider and statement.contractYear == query.contractYear|int and statement.statement == query.statement %}
                    {% set currentStatement = statement %}
                {% endif %}
            {% endfor %}
            
            {# Generate random financial data #}
            {% if currentStatement %}
                {% set seedValue = (query.provider | length) + (query.statement | length) + query.contractYear|int %}
                
                {% if currentStatement.status == "Not applicable" %}
                    {# Generate service fee only for service fee statements #}
                    {% set baseAmount = (seedValue * 891) % 15000 + 5000 %}
                    {% set serviceFee = (baseAmount * 0.037) %}
                    {% set vatAmount = (serviceFee * 0.2) %}
                    {% set grandTotal = serviceFee + vatAmount %}
                    
                    {# No output payments, clawbacks, or uplifts for service fee statements #}
                    {% set totalOutputPayment = 0 %}
                    {% set ectOutputTotal = 0 %}
                    {% set mentorOutputTotal = 0 %}
                    {% set clawbackAmount = 0 %}
                    {% set upliftTotal = 0 %}
                {% else %}
                    {# Generate full financial data for non-service fee statements #}
                    {% set baseAmount = (seedValue * 1247) % 50000 + 10000 %}
                    
                    {# Generate output payment amounts #}
                    {% if query.contractYear|int >= 2025 %}
                        {% set ectStarted = ((seedValue * 17) % 8) + 2 %}
                        {% set ectRetained1 = ((seedValue * 23) % 5) %}
                        {% set ectRetained2 = ((seedValue * 31) % 4) %}
                        {% set ectCompleted = ((seedValue * 41) % 6) %}
                        {% set mentorStarted = ((seedValue * 19) % 4) %}
                        {% set mentorCompleted = ((seedValue * 29) % 3) %}
                        
                        {% set ectOutputTotal = (ectStarted * 173.64) + (ectRetained1 * 130.23) + (ectRetained2 * 130.23) + (ectCompleted * 173.64) %}
                        {% set mentorOutputTotal = (mentorStarted * 500) + (mentorCompleted * 500) %}
                        {% set totalOutputPayment = ectOutputTotal + mentorOutputTotal %}
                    {% else %}
                        {% set bandAStarted = ((seedValue * 13) % 6) + 1 %}
                        {% set bandBStarted = ((seedValue * 17) % 5) %}
                        {% set bandCStarted = ((seedValue * 19) % 4) %}
                        {% set bandDStarted = ((seedValue * 23) % 3) %}
                        {% set bandARetained = ((seedValue * 29) % 4) %}
                        {% set bandBRetained = ((seedValue * 31) % 3) %}
                        {% set bandACompleted = ((seedValue * 37) % 3) %}
                        
                        {% set startedTotal = (bandAStarted * 119.40) + (bandBStarted * 117.48) + (bandCStarted * 115.92) + (bandDStarted * 193.20) %}
                        {% set retainedTotal = (bandARetained * 89.55) + (bandBRetained * 88.11) %}
                        {% set completedTotal = (bandACompleted * 119.40) %}
                        {% set totalOutputPayment = startedTotal + retainedTotal + completedTotal %}
                        
                        {% set upliftParticipants = ((seedValue * 43) % 8) %}
                        {% set upliftTotal = upliftParticipants * 100 %}
                    {% endif %}
                    
                    {# Service fee - always present #}
                    {% set serviceFee = (baseAmount * 0.037) %}
                    
                    {# Clawbacks #}
                    {% set clawbackAmount = ((seedValue * 7) % 500) + 50 %}
                    
                    {# VAT calculation #}
                    {% set subtotal = totalOutputPayment + serviceFee - clawbackAmount + (upliftTotal or 0) %}
                    {% set vatAmount = (subtotal * 0.2) %}
                    
                                    {# Final total #}
                {% set grandTotal = subtotal + vatAmount %}
                {% endif %}
                
                {# Calculate adjustments total #}
                {% set adjustmentsTotal = 0 %}
                {% if data['adjustmentArray'] %}
                    {% for item in data['adjustmentArray'] %}
                        {% set adjustmentsTotal = adjustmentsTotal + (item.amount|float) %}
                    {% endfor %}
                {% endif %}
                
                {# Add adjustments to grand total #}
                {% set grandTotal = grandTotal + adjustmentsTotal %}
                
                {# Declaration counts - match the payment calculations #}
                {% if currentStatement.status == "Not applicable" %}
                    {# No declarations for service fee statements #}
                    {% set declStarted = 0 %}
                    {% set declRetained = 0 %}
                    {% set declCompleted = 0 %}
                    {% set declExtended = 0 %}
                    {% set declClawedBack = 0 %}
                    {% set declVoided = 0 %}
                {% else %}
                    {# Use the same counts as payment calculations #}
                    {% if query.contractYear|int >= 2025 %}
                        {% set declStarted = ectStarted %}
                        {% set declRetained = ectRetained1 + ectRetained2 %}
                        {% set declCompleted = ectCompleted %}
                        {% set declExtended = ((seedValue * 19) % 3) %}
                        {% set declClawedBack = ((seedValue * 23) % 4) %}
                        {% set declVoided = ((seedValue * 29) % 2) %}
                    {% else %}
                        {% set declStarted = bandAStarted + bandBStarted + bandCStarted + bandDStarted %}
                        {% set declRetained = bandARetained + bandBRetained %}
                        {% set declCompleted = bandACompleted %}
                        {% set declExtended = ((seedValue * 19) % 3) %}
                        {% set declClawedBack = ((seedValue * 23) % 4) %}
                        {% set declVoided = ((seedValue * 29) % 2) %}
                    {% endif %}
                {% endif %}
            {% endif %}
            
            <div class="finance-panel__summary__total-payment-breakdown">
                <table class="govuk-table">
                    <caption class="govuk-table__caption govuk-table__caption--l">Total £{% if currentStatement %}{{ currency(grandTotal) }}{% else %}0.00{% endif %}</caption>
                    <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th class="govuk-table__header" scope="col"></th>
                        <th class="govuk-table__header" scope="col"></th>
                    </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                    {% if query.contractYear|int >= 2025 %}
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">ECTs output payment</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(ectOutputTotal) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Mentors output payment</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(mentorOutputTotal) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Service fee</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement %}{{ currency(serviceFee) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">ECT clawbacks</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(clawbackAmount/2) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Mentor clawbacks</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(clawbackAmount/2) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Additional adjustments</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement %}{{ currency(adjustmentsTotal) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">VAT</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement %}{{ currency(vatAmount) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    {% else %}
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Output payment</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(totalOutputPayment) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Service fee</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement %}{{ currency(serviceFee) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Uplift fees</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(upliftTotal) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Clawbacks</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement and currentStatement.status != "Not applicable" %}{{ currency(clawbackAmount) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Additional adjustments</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement %}{{ currency(adjustmentsTotal) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">VAT</td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">£{% if currentStatement %}{{ currency(vatAmount) }}{% else %}0.00{% endif %}</td>
                    </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <form class="govuk-!-margin-top-6" method="post">
            <input type="hidden" name="provider" value="{{ query.provider }}">
            <input type="hidden" name="contractYear" value="{{ query.contractYear }}">
            <input type="hidden" name="statement" value="{{ query.statement }}">
            {{ govukCheckboxes({
                idPrefix: "assurance-checks",
                name: "assurance-checks",
                errorMessage: { text: errors.assuranceChecks } if errors and errors.assuranceChecks else false,
                items: [
                    {
                        value: "yes",
                        text: "I confirm I've completed all assurance checks and I authorise payment",
                        checked: assuranceChecks == "yes"
                    }
                ]
            }) }}

            <button class="govuk-button" type="submit">Authorise for payment</button>
        </form>
    </div>
</div>
{% endblock %}

{% block pageScripts %}
<script>
    function formatCurrency() {
        // Target specific elements that contain currency amounts
        const selectors = [
            '.govuk-table__cell--numeric',
            '.govuk-table__caption', 
            '.govuk-heading-s'
        ];
        
        selectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            
            elements.forEach(element => {
                const originalText = element.textContent;
                if (originalText && originalText.includes('£')) {
                    // Replace currency amounts with thousand separators (for 4+ digits)
                    // Handle whitespace between £ and numbers
                    const newText = originalText.replace(/£\s*(\d{4,})\.(\d{2})/g, function(match, number, decimals) {
                        const formatted = number.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        return '£' + formatted + '.' + decimals;
                    });
                    
                    if (newText !== originalText) {
                        element.textContent = newText;
                    }
                }
            });
        });
    }
    
    // Run after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(formatCurrency, 10);
    });
</script>
{% endblock %}
